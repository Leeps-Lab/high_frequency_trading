{% extends "global/Page.html" %}
{% load staticfiles otree %}
{% load staticfiles %}

{% block content %}
<style type="text/css">
    .front_end_controller{
        width: 100%;
        height: 100vh;
        background-color: darkgrey;
        margin-top: -80px;
    }

    .info_table{
        width:100%;
    }
    .graph_row{
        margin-top: 20px;
        background-color: darkgrey;
        width: 100%;
        height:76%;
        margin-left: 00px;
        border-top:solid black 1px;
    }
    .profit_graph{
        width:50%;
        height:100%;
    }
    .spread_graph{
        width:50%;
        height:100%;
    }
    .button-on{
        background-color:steelblue;
        border-color: solid black 5px;
        color:white;
    }
    .button-pressed{
        background-color:#444444;
        color:white;
    }
    .button-off{
        background-color:#666666;
        color:white;
    }
    input{
        margin-left:30px;
        margin-top:20px;
    }
    .inputs{
        margin-top:160px;
        width: 10%;
        height: 100%;
    }
    .line {
        stroke: steelblue;
        stroke-width: 3.5px;
        fill: none;
    }
    g{
        color:  grey;
        stroke-width: 2px;
        fill: none;

    }
    /* The switch - the box around the slider */
.switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}

/* Hide default HTML checkbox */
.switch input {display:none;}

/* The slider */
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .slider {
  background-color: #1fd15a;
}

input:focus + .slider {
  box-shadow: 0 0 1px #1fd15a;
}

input:checked + .slider:before {
  -webkit-transform: translateX(26px);
  -ms-transform: translateX(26px);
  transform: translateX(26px);
}

/* Rounded sliders */
.slider.round {
  border-radius: 34px;
}

.slider.round:before {
  border-radius: 50%;
}
.my_line{
  stroke:steelblue;
  stroke-width:2px;
}

.others_line{
  stroke:rgb(2, 3, 4);
  stroke-width:2px;
}

.green_bar{
  fill:#6edd68;
  opacity: 0.5;
}
.blue_bar{

}

body {
    padding: 10px;
    /*height: 100%;*/
    /*width: 100%;*/
    /*background-color: red;*/
}
.zoom-in, .zoom-out {
    cursor: pointer;
    position: absolute;
    right: 40px;
    width: 20px;
    height: 20px;
    text-align: center;
    border: 1px solid rgb(200, 200, 200);
    background-color: white;
    font-weight: bold;
    -webkit-user-select: none
}

.zoom-in {
    top: 20px;
    line-height: 18px;
}

.zoom-out {
    top: 45px;
    line-height: 17px;
}

.zoom-disabled {
    pointer-events: none;
    cursor: default;
    background-color: lightgray;
}

/*#slider {
    margin: auto;
    margin-top: 20px;
    margin-bottom: 10px;
    height: 180px;
}*/

#slider {
    /*margin: auto;*/
    margin-top: 0px;
    margin-bottom: 0px;
    margin-left: 450px;         /*how to make this not a floating number*/
    height: 50px;
}

.ui-slider {
    border-radius: 0;
}

.ui-slider .ui-slider-handle {
    display: none;
}

.ui-slider .ui-slider-range {
    position: absolute;
    z-index: 1;
    border-radius: 0;
    background: none;
    background-color: rgb(26, 73, 232);
}

.slider-spread-indicators {
    position: absolute;
    z-index: 1;
    right: -5px;
    bottom: 0;
    border-top: 2px solid black;
    width: 10px;
}

#slider-container {
    float: center;
    width: 100%;
    height: 50%;
    padding-top: 10px
}

#slider-val {
    margin: auto;
    width: 50px;
    display: block;
}

#buttons-container {
    /*text-align: left;*/
    /*float: left;*/
    float: center;
    width: 70%;
    height: 100%;
    padding: 10px;
}


#graph-controls {
    margin-top: 20px;
}

#data-container {
    width: 100%;
    height: 100%;
    border: 1px solid transparent;
}

.status-table {
    margin-top: 20px;
    height: 50%;
    background-color: white;
    /*overflow: auto;*/
    border: 1px solid rgb(200, 200, 200);
}

/*styles for table state indication entries
  capital is to make it work better with ng-style*/
.state-label-Snipe {
    background-color: rgba(200, 79, 34, .5);
}

.state-label-Maker {
    background-color: rgba(26, 73, 232, .5);
}

.state-label-Out {
    background-color: rgba(110, 110, 110, .5);
}

.status-display {
    margin-top: 15px;
}

.data-heading {
    margin-top: 20px;
    text-align: center;
    background-color: white;
}

.speed-label {
    font-size: 24px;
    margin-bottom: 5px;
}

.state-label {
    font-size: 24px;
}

.spread-label {
    font-size: 24px;
}

.ui-container {
    margin-bottom: 60px;
}

.top-left-screen {
    border: rgb(200, 200, 200) 2px solid;
    /*background-color: rgb(230, 230, 230);*/
    background-color: white;
    z-index: 100;                           /*test for adding invisible slider*/
}

.top-right-screen {
    margin-left: 25px;
    border: rgb(200, 200, 200) 2px solid;
    background-color: rgb(230, 230, 230);
}

.bottom-left-screen {
    border: rgb(200, 200, 200) 2px solid;
    background-color: rgb(230, 230, 230);
}

.top-banner {
    /*margin-bottom: 5px;*/
    border: rgb(200, 200, 200) 2px solid;
    background-color: rgb(230, 230, 230);
    width: 100%;
}

.profit-graph-container {
    height: 500px;
    margin: 40px;
    width: 70%;
    /*border: rgb(200, 200, 200) 1px solid;*/
    background-color: rgb(230, 230, 230);
}

.user-graph-container {
    height: 500px;
    margin: 20px;
    width: 20%;
    /*border: rgb(200, 200, 200) 1px solid;*/
    background-color: rgb(230, 230, 230);
}

.table{
    table-layout : auto;
    padding-bottom: 0px;
}

.control-container {
    height: 500px;
    width: 10%;
    /*border: rgb(200, 200, 200) 1px solid;*/
    background-color: rgb(230, 230, 230);
    display: flex;
    flex-direction: column;
    align-items: center;
}

.button-container-state {
    background-color: rgb(230, 230, 230);
    padding-bottom: 5px;
    flex: 1 1 auto;
    display: flex;
    justify-content: center;
    flex-direction: column;
}

.button-container-speed {
    background-color: rgb(230, 230, 230);
    flex: 1 1 auto;
}

.graph-screen-wrapper {
    height: 225px;  /*changed from 450 on 7/26/17 for displaying a smaller graph*/
    margin: 40px;
}

.screen-wrapper {
    height: 450px;
    margin: 40px;
}

.screen {
    width: 100%;
    height: 100%;
}


.button-container-spread {
    border: 1px solid rgb(200, 200, 200);
    padding: 10px;
}

.state-selected {
    color: white;
    border: 2px solid black;
}

#state_out.state-selected {
    background-color: rgb(110, 110, 110);
}

#state_snipe.state-selected {
    background-color: rgb(200, 79, 34);
}

#state_maker.state-selected {
    background-color: rgb(26, 73, 232);
}

.state-not-selected {
    color: white;
    border: 2px solid gray;
    background-color: gray;
}

.row {
    padding: 0px;
    margin: 0px;
}

[class*="col-"] {
    padding: 0px;
    margin: 0px;
}

/*material switch css*/
/*stolen from http://bootsnipp.com/snippets/featured/material-design-switch*/

.material-switch > input[type="checkbox"] {
    display: none;
}
.material-switch > label {
    cursor: pointer;
    height: 0px;
    position: relative;
    width: 40px;
    text-align: left;
    /*switch color*/
    background-color: green;
}
.material-switch > label::before {
    background: rgb(0, 0, 0);
    box-shadow: inset 0px 0px 10px rgba(0, 0, 0, 0.5);
    border-radius: 8px;
    content: '';
    height: 16px;
    margin-top: -8px;
    position:absolute;
    opacity: 0.3;
    transition: all 0.4s ease-in-out;
    width: 40px;
}
.material-switch > label::after {
    background: rgb(255, 255, 255);
    border-radius: 16px;
    box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.3);
    content: '';
    height: 24px;
    left: -4px;
    margin-top: -8px;
    position: absolute;
    top: -4px;
    transition: all 0.3s ease-in-out;
    width: 24px;
}
.material-switch > input[type="checkbox"]:checked + label::before {
    background: inherit;
    opacity: 0.5;
}
.material-switch > input[type="checkbox"]:checked + label::after {
    background: inherit;
    left: 20px;
}
.material-switch > input[disabled] + label {
    cursor: not-allowed;
}
</style>
<div class="front_end_controller">
    <table class="info_table" style="width:100%" >
        <strong>
        <!-- Row 1 of info box -->
        <tr>
            <td class="info_text">Player ID:            <span id="player_id"></span></td>
            <td class="info_text">Number of Traders:    <span id="num_traders"></span></td>
            <td class="info_text">Role:                 <span id="player_role"> </span> </td>
            <td class="info_text">Fundamental Value:    <span id="fp"></span></td>
        </tr>
        <!-- Row 2 of info box -->
        <tr>
            <td class="info_text">Period:               <span id="period_id"></span></td>
            <td class="info_text">Number of Makers:     <span id=num_makers></span></td>
            <td class="info_text">Spread:               <span id="spread_value"></span> </td>
            <td class="info_text">Current Buy Offer:    <span id="curr_bid"></span></td>
        </tr>
        <!-- Row 3 of info box -->
        <tr>
            <td class="info_text">Speed Cost:           <span id="speed_cost"></span></td>
            <td class="info_text">Number of Snipers:    <span id="num_snipers"></span></td>
            <td class="info_text">Your Profit:          <span id="profit"></span></td>
            <td class="info_text">Current Sell Offer:   <span id="curr_ask"></span></td>
        </tr>
        </strong>
    </table>
    <div class="row graph_row" style="width:100%; height:100%;">

    <svg id="profit-graph"  style="width:60%; height:100%; background-color: white; border-left:solid black 1px;">
        <span class="zoom-in" id="profit-zoom-in" ng-class="{'zoom-disabled': tradingGraph.expandedGraph}">+</span>
        <span class="zoom-out" id="profit-zoom-out" ng-class="{'zoom-disabled': tradingGraph.expandedGraph}">-</span>
    </svg>


    <!-- graph the profit -->
    <!-- <div class="col-xs-8 profit-graph-container" style="padding: 5px"> -->
        <!-- <svg width="100%" height="100%" id="profit-graph"> -->
            <!-- tradingGraph.expandedGraph? -->
            <!-- <span class="zoom-in" id="profit-zoom-in" ng-class="{'zoom-disabled': tradingGraph.expandedGraph}">+</span> -->
            <!-- <span class="zoom-out" id="profit-zoom-out" ng-class="{'zoom-disabled': tradingGraph.expandedGraph}">-</span> -->
        <!-- </svg> -->
    <!-- </div> -->

    <svg id="spread-graph" style=" width:25%; height:100%; margin-left:10px; background-color: white;"></svg> 
        <div class="inputs">
          <input id="maker" value="maker" class="button-off" type="button" style="width:80px" ></input>
          <br>
            <input id="sniper" value="sniper" class="button-off" type="button" style="width:80px" ></input> 
            <br>
            <input id="out" value="out" class="button-on" type="button" style="width:80px"></input>
            <br>

            <p  style="text-align: center; margin-left: 30px; margin-top:50px;">Speed</p>
            <label class="switch" style="margin-left: 40px; margin-top: -5px;" >
                <br>
                <input type="checkbox" onclick="updatespeed()">
                <span class="slider round"></span>
            </label>

        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
    <script src="https://d3js.org/d3.v5.js"></script>
    <script src="https://momentjs.com/downloads/moment.js"></script>
    <script src="https://momentjs.com/downloads/moment-timezone.min.js"></script>
<script>

/*Front End Javascript for start.html*/
/*Handles the Button Logic and the Graph shown in start.html*/

window.onload = function () {

    // Establish websocket variables
    var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
    var socket = new WebSocket(ws_scheme + '://' + window.location.host + "/hft/{{group.id}}/{{player.id}}/");

    // Handle any errors that occur.
    socket.onerror = function (error) {
        console.log('WebSocket Error: ' + error);
    };

    // Show a connected message when the WebSocket is opened.
    socket.onopen = function (event) {
        console.log('Client has connected to django channels');
    };

    // Handle messages sent by the server.
    socket.onmessage = function (event) {
        var obj = jQuery.parseJSON(event.data);
        if(obj.FPC != undefined){
            $('#fp').html(obj.FPC);

        } 

        // switch statement on type of data parsed from event
    };

    // Show a disconnected message when the WebSocket is closed.
    socket.onclose = function (event) {
        console.log('disconnected from oTree');
    };




    /*
        Set as many info box default values as possible from initial data

    */
    $('#player_id').html({{player.id_in_group}});
    $('#period_id').html(1);
    $('#speed_cost').html(0);

    $('#num_traders').html({{Constants.players_per_group}});
    $('#num_snipers').html(0);
    $('#num_makers').html(0);
    
    $('#player_role').html('OUT');
    $('#spread_value').html('N/A');
    $('#profit').html(20);

//-> buggyas fuc,k    // $('#fp').html(player.fp);
    $('#curr_bid').html('N/A');
    $('#curr_ask').html('N/A');


    // On load global var? Terrible
    var speed = false;

    // Called on click to toggle input
    updatespeed = function () {
        speed = !speed;
        if(speed){
            $('#speed_cost').html({{Constants.speed_cost}});
        }else {
            $('#speed_cost').html(0);
        }
        var msg = {
            type: 'speed_change',
            id: {{player.id}},
            id_in_group: {{player.id_in_group}},
            speed: speed
        };
        if (socket.readyState === socket.OPEN) {
            socket.send(JSON.stringify(msg));
        }
    }


    document.getElementById("maker").onclick = function () {
        if ((document.getElementById("maker").className == "button-off") && (document.getElementById("maker").className != "button-pressed")){
            //IF BUTTON IS NOT PRESSED OR ON THEN TURN IT ON AFTER DELAD (Button_Pressed())
            $("#maker").toggleClass('button-off button-pressed');
            var msg = {
                type: 'role_change',
                id: {{player.id}},
                id_in_group: {{player.id_in_group}},
                state: "MAKER"
            };
            if (socket.readyState === socket.OPEN) {
              socket.send(JSON.stringify(msg));
            }

            Button_Pressed("maker");
            $('#player_role').html('Maker');

            Spread_Graph.spread(); // Auto Input Spread
            Spread_Graph.drawMyLine(); // Auto input spread
        }
        $("#out").attr('class', 'button-off');
        $("#sniper").attr('class', 'button-off');
    };

    document.getElementById("sniper").onclick = function () {
        if ((document.getElementById("sniper").className == "button-off") && (document.getElementById("sniper").className != "button-pressed")){
            //IF BUTTON IS NOT PRESSED OR ON THEN TURN IT ON AFTER DELAD (Button_Pressed())
            $("#sniper").toggleClass('button-off button-pressed');
            var msg = {
                type: 'role_change',
                id: {{player.id}},
                id_in_group: {{player.id_in_group}},
                state: "SNIPER"
            };
            if (socket.readyState === socket.OPEN) {
                socket.send(JSON.stringify(msg));
            }
            Button_Pressed("sniper");
            $('#player_role').html('Sniper');

            Spread_Graph.clear();
        }

        $("#maker").attr('class', 'button-off');
        $("#out").attr('class', 'button-off');
    };

  //OUT BUTTON
    document.getElementById("out").onclick = function () {
        if (document.getElementById("out").className == "button-off"){
            //IF THE BUTTON IS OFF TURN IT ON WITH NO DELAY
            $("#out").toggleClass('button-off button-on');
            var msg = {
                type: 'role_change',
                id: {{player.id}},
                id_in_group: {{player.id_in_group}},
                state: "OUT"
            };
            if (socket.readyState === socket.OPEN) {
                socket.send(JSON.stringify(msg));
            }
            Button_Pressed("out");
            $('#player_role').html('Out');

            Spread_Graph.clear();
        }

        $("#maker").attr('class', 'button-off');
        $("#sniper").attr('class', 'button-off');
    };

    var button_timer;
    var graph_timer;
    function Button_Pressed(id_name){
        //Wait .5 seconds for button pressed to even for fast players
        // to eliminate spam clicking
        button_timer = setTimeout(Button_Change.bind(null,id_name),500);
    }
    function Button_Change(id_name){
        //TURNING BUTTON ON
        $("#"+id_name).toggleClass('button-pressed button-on');
    }


    var Spread_Graph = {};
    var Profit_Graph = {};

    var Other_Maker_lines = {};

    var n = 20; 
    var data = d3.range(17).map(function(d) { return  0}); //Testing Purposes
    var max_spread = 10; // Pull from Constansts
    var auto_spread = 2;


    // Functions for drawing choice box
    (function() {

        var spread_width = $("#spread-graph").width(),
          spread_height = $("#spread-graph").height(),
          spread_svg = d3.select("#spread-graph")
                      .attr("width", spread_width)
                      .attr("height", spread_height);


        function drawStartState(){
        spread_line = spread_svg.append("svg:line")
                       .attr("x1", spread_width/2)
                       .attr("y1", 0)
                       .attr("x2", spread_width/2)
                       .attr("y2", spread_height)
                       .style("stroke", "lightgrey")
                       .style("stroke-width", 5);

        spread_line_fundamental_price = spread_svg.append("svg:line")
                       .attr("x1", spread_width - (spread_width - 45))
                       .attr("y1", spread_height/2 - 90)
                       .attr("x2", spread_width - 45)
                       .attr("y2", spread_height/2 - 90)
                       .style("stroke", "grey")
                       .style("stroke-width", 5);

        }

        /***********************************************
        DEALING WITH MOUSE CLICKS ON THE SPREAD GRAPHS
        ************************************************/
        function svgClickListener(){
            spread_svg.on('click',function(d) { 
                role = $("#player_role").text();
                if(role == "Maker"){

                    //The dimensions the svg take up
                    spread_x = document.getElementById("spread-graph").getBoundingClientRect().left;
                    spread_y = document.getElementById("spread-graph").getBoundingClientRect().top;
                    console.log(spread_x+"," +spread_y);
                    //Where the grey middle line is
                    svg_middle_x = spread_width/2;
                    svg_middle_y = spread_height/2 - 90;

                    //The tuple in which the mouse is clicked within the svg 
                    spread_position = {x:(d3.event.clientX - spread_x),y:(d3.event.clientY - spread_y)};

                    //finding the distance from the mid
                    if(spread_position.y >= svg_middle_y){
                        distance_from_middle = spread_position.y - svg_middle_y;
                    } else {
                        distance_from_middle = svg_middle_y -spread_position.y ;
                    }
                    //Ratio between the distance and the mid
                    ratio = svg_middle_y / distance_from_middle;

                    //Spread is the ratio except in dollars which is what the actual spread is
                    money_ratio = max_spread/ratio;
                    my_spread = money_ratio.toFixed(2);

                    spreadChange(my_spread);
                    //Time to draw the lasers tat go into the spread graph

                    drawMySpreadLine(my_spread);
                }
            });
        }

        function drawMySpreadLine(my_spread = auto_spread){
            d3.selectAll(".my_line").remove();
            d3.selectAll("rect").remove();
            spread_y = document.getElementById("spread-graph").getBoundingClientRect().top;
            //Where the grey middle line is
            svg_middle_y = spread_height/2 - 90;

            money_ratio =  max_spread/my_spread;
            y_coordinate = svg_middle_y/money_ratio;
            // console.log(y_coordinate);
            //Ratio between the distance and the mid

            your_spread_line_top = spread_svg.append("svg:line")
                   .attr("x1", spread_width - 35)
                   .attr("y1", svg_middle_y - y_coordinate)
                   .attr("x2", spread_width)
                   .attr("y2", svg_middle_y - y_coordinate)
                   .attr("class","my_line");

            your_spread_line_bottom = spread_svg.append("svg:line")
                   .attr("x1", spread_width - 35)
                   .attr("y1", y_coordinate + svg_middle_y)
                   .attr("x2", spread_width)
                   .attr("y2", y_coordinate + svg_middle_y)
                   .attr("class","my_line");
            //WAIT FOR SPEED AND THEN SET THE SPREAD with the bar line

            addLineAnimation();

            setTimeout(function(d){
            drawSpreadBar(my_spread,svg_middle_y,y_coordinate);
            }, 500);

          //Timeout is whether or not speed is on
        }

        function addLineAnimation(){
            //SETTING THE SPREAD TO THE LINE
            spread_lines = d3.selectAll(".my_line");
            add_animation = spread_lines
                        .transition()
                        // duration is whether or not speed is on
                        .duration(500)
                        .attr("x1", 85)
                        .attr("x2", spread_width - 85);         
        }


        function drawOthersSpreadLine(my_spread, ordertoken_buy, ordertoken_sell, speed){
            spread_y = document.getElementById("spread-graph").getBoundingClientRect().top;

            //Where the grey middle line is
            svg_middle_y = spread_height/2 - 90;
            money_ratio =  max_spread/my_spread;
            y_coordinate = svg_middle_y/money_ratio;
            // console.log(y_coordinate);
            //Ratio between the distance and the mid

            your_spread_line_top = spread_svg.append("svg:line")
                   .attr("x1", spread_width - 35)
                   .attr("y1", svg_middle_y - y_coordinate)
                   .attr("x2", spread_width)
                   .attr("y2", svg_middle_y - y_coordinate)
                   .attr("class","others_line");


            your_spread_line_bottom = spread_svg.append("svg:line")
                   .attr("x1", spread_width - 35)
                   .attr("y1", y_coordinate + svg_middle_y)
                   .attr("x2", spread_width)
                   .attr("y2", y_coordinate + svg_middle_y)
                   .attr("class","others_line");

            // for removing when a transation occurs
            Other_Maker_lines[ordertoken_sell] = [your_spread_line_top, your_spread_line_bottom]
            Other_Maker_lines[ordertoken_buy] = [your_spread_line_top, your_spread_line_bottom]

            addOthersLineAnimation([your_spread_line_top, your_spread_line_bottom]);
            //Timeout is whether or not speed is on
        }

        function addOthersLineAnimation(lines){
            //SETTING THE SPREAD TO THE LINE
            for( i = 0; i < 2; i++){
                add_animation = lines[i]
                  .transition()
                  // duration is whether or not speed is on
                  .duration(500)
                  .attr("x1", 85)
                  .attr("x2", spread_width - 85); 
            }      
          
        }
  

        function drawTransactionBar(my_spread,svg_middle_y,y_coordinate,side){
            //take into account
            var bar_color = "green_bar";

            //if not other maker within the spread
            if(side === 'B'){
                your_bar_rect = spread_svg.append("svg:rect")
                    .attr("x", spread_width - (spread_width - 85) + 40)
                    .attr("y", svg_middle_y)
                    .attr("width", (spread_width - 220) / 2)
                    .attr("height", y_coordinate)
                    .attr("class",bar_color);
            } else if(side === 'S'){
                newY = y_coordinate * -1;
                your_bar_rect = spread_svg.append("svg:rect")
                        .attr("x", spread_width - (spread_width - 85) + 40)
                        .attr("y", svg_middle_y - y_coordinate)
                        .attr("width", (spread_width - 220) / 2)
                        .attr("height", y_coordinate)
                        .attr("class",bar_color);
            }
        }

        function drawSpreadBar(my_spread,svg_middle_y,y_coordinate){
            //take into account
            var bar_color = "";

            //if not other maker within the spread
            bar_color = "green_bar";
            your_bar_rect = spread_svg.append("svg:rect")
                       .attr("x", spread_width - (spread_width - 85))
                       .attr("y", svg_middle_y - y_coordinate)
                       .attr("width", spread_width - 170)
                       .attr("height", 2*y_coordinate)
                       .attr("class",bar_color);
        }

        function clearGraph(){
            d3.selectAll(".my_line").remove();
            d3.selectAll(".others_line").remove();
            d3.selectAll("rect").remove();
        }

        function removeOtherMakerLine(order_token){
            var lines_to_remove = Other_Maker_lines[order_token];
            lines_to_remove[0].remove();
            lines_to_remove[1].remove();

        }

        function spreadChange(my_spread = auto_spread){

            var msg = {
                type: 'spread_change',
                id: {{player.id}},
                id_in_group: {{player.id_in_group}},
                spread: my_spread
            };
            if (socket.readyState === socket.OPEN) {
                socket.send(JSON.stringify(msg));
            }
            $("#spread_value").text('+-$'+my_spread);
        }

        Spread_Graph.start = drawStartState;
        Spread_Graph.drawMyLine = drawMySpreadLine;
        Spread_Graph.drawOthersLine = drawOthersSpreadLine;
        Spread_Graph.animateLine = addLineAnimation;
        Spread_Graph.drawBar = drawSpreadBar;
        Spread_Graph.listen = svgClickListener;
        Spread_Graph.clear = clearGraph;
        Spread_Graph.spread = spreadChange;
    }());

Spread_Graph.start();
Spread_Graph.listen();


(function(){

}());

    var graph = {};

    graph.profitElementId = "profit-graph";                         // id of the profit graph svg element
    graph.profitElementWidth = $('#' + graph.profitElementId).width();                                //Width and height of the profit svg element
    graph.profitElementHeight = $('#' + graph.profitElementId).height();    
    graph.axisLabelWidth = 40;    //used                                  //Width of area where price axis labels are drawn
    graph.graphPaddingRight = 20;  //used                                 // how far from the x axis label that the line stops moving
    graph.profitSVG = d3.select('#' + graph.profitElementId);       //profit svg element
    graph.minPriceProfit = 0;      //used                                 //min price on price axis for profit graph
    graph.maxPriceProfit = 0;      //used                                 //max price on price axis for profit graph
    graph.centerPriceProfit = 0;   //used
    graph.graphAdjustSpeedMarket = .1;                              //speed that market price axis adjusts in pixels per frame
    graph.graphAdjustSpeedProfit = .1;                              //speed that profit price axis adjusts in pixels per frame
    graph.marketPriceGridIncrement = 1;                             //amount between each line on market price axis
    graph.profitPriceGridIncrement = 1;         //used                    //amount between each line on profit price axis
    graph.contractedTimeInterval = 60;                              //amount of time displayed on time axis when graph is contracted
    graph.timeInterval = graph.contractedTimeInterval;  //used            //current amount in seconds displayed at once on full time axis
    graph.timeIncrement = 5;                                        //Amount in seconds between lines on time axis
    graph.currentTime = 0;                                          //Time displayed on graph
    graph.profitPriceLines = [];           
    graph.timeLines = [];
    graph.pricesArray = [];
    graph.adminStartTime = {{subsession.start_time}};
    console.log(graph.adminStartTime);
    // graph.timeOffset = playerTimeOffset;                         //offset to adjust for clock difference between lab computers
    graph.timeOffset = 0;                                           //offset to adjust for clock difference between lab computers

    graph.timeSinceStart = 0;                                       //the amount of time since the start of the experiment in seconds
    graph.timePerPixel = 0;    //used                                     // number of ms represented by one pixel
    graph.advanceTimeShown = 0;  //used                                   // the amount of time shown to the right of the current time on the graph

    graph.priceRange = 10;

    graph.marketZoomLevel = 4;                                      // current zoom level for each graph
    graph.profitZoomLevel = 4;
    graph.maxZoomLevel = 4;                                         // maximum allowed zoom level
    graph.zoomAmount = 0;                                           // amount zoomed per click

    graph.expandedGraph = false;
    graph.prevMaxPriceMarket = 0;                                   // storage for previous max and min values for when graph is in expanded mode
    graph.prevMinPriceMarket = 0;
    graph.prevMaxPriceProfit = 0;
    graph.prevMinPriceProfit = 0;

    graph.op = 1;                                                  //added 7/24/17 for adding opacity to transaction lines
    graph.currentTransaction = null;                               //added 7/24/17 for ensuring only the correct orders are drawn as transacted
    graph.currTransactionID = null;                                //added 7/24/17 for ensuring only the correct orders are drawn as transacted
    graph.heightScale = .4;                                        //added 7/26/17 to shift the height of the graph to fit buttons under
    graph.widthScale = 0;                                          //added 7/28/17 to widen the graphs of ticks to be better fit spread 
    graph.oldFundPrice = null;
    graph.FPCop = 1;
    graph.currSpreadTick = 0;
    graph.startTime = 0;
    graph.tickAnimationID = 0;
    graph.staticTickAnimationID = 0;
    graph.laser = true;                                            //magic
    graph.removeStartTime = 0;
    graph.removeAnimationID = 0;
    graph.removeStaticAnimationID = 0;
    graph.IDArray = [];
    graph.slowDelay = 500;                   
    graph.fastDelay = 100;
    graph.FPCswing = null;                                        //used for shifting spread ticks with FPC's
    graph.currentSellTick = [];
    graph.currentBuyTick = [];
    graph.PreviousProfit = 0;
    graph.maxSpread = 2.0;  //USED
    graph.profit = 0; 

    
    function calcPriceGridLines(maxPrice, minPrice, increment) {
        var gridLineVal = minPrice + increment - (minPrice % increment);
        // adjust for mod of negative numbers not being negative
        if(minPrice < 0) gridLineVal -= increment;
        var lines = [];
        while (gridLineVal < maxPrice) {
            lines.push(gridLineVal);
            gridLineVal += increment;
        }
        return lines;
    };
    

    function calcTimeGridLines(startTime, endTime, increment) {
        var timeLineVal = startTime - ((startTime - graph.adminStartTime) % increment);
        var lines = [];
        while (timeLineVal < endTime) {
            lines.push(timeLineVal);
            timeLineVal += increment;
        }
        return lines;
    };

    // return the number of nanoseconds since midnight
    function getTime(){
        var m = moment().tz("America/Los_Angeles"); 
        var hours =   m.hours()       *(60*60)*1000000000;
        var minutes = m.minutes()     *60*1000000000;
        var seconds = m.seconds()     *1000000000;
        var millis  = m.milliseconds()*1000000;
        return hours+minutes+seconds+millis;
    }

    function mapTimeToXAxis(timeStamp) {
        var percentOffset;
        if (graph.timeSinceStart >= graph.timeInterval) {
            percentOffset = (timeStamp - (graph.currentTime - (graph.timeInterval * 1000000000))) / (graph.timeInterval * 1000000000);
        }else {
            percentOffset = (timeStamp - graph.adminStartTime) / (graph.timeInterval * 1000000000);
        }
        return (graph.profitElementWidth - graph.axisLabelWidth - graph.graphPaddingRight) * percentOffset;   //changed 7/27/17
    };

    function calcPriceBounds() {
        //calc bounds for profit graph

        if (graph.profit > (.2 * graph.minPriceProfit) + (.8 * graph.maxPriceProfit) ||
            graph.profit < (.8 * graph.minPriceProfit) + (.2 * graph.maxPriceProfit)) {
            graph.centerPriceProfit = graph.profit;
        }

        var curCenterProfit = (graph.maxPriceProfit + graph.minPriceProfit) / 2;

        if (Math.abs(graph.centerPriceProfit - curCenterProfit) > 1) {
            graph.profitPriceLines = calcPriceGridLines(graph.maxPriceProfit, graph.minPriceProfit, graph.profitPriceGridIncrement);
            if (graph.centerPriceProfit > curCenterProfit) {
               graph.maxPriceProfit += graph.graphAdjustSpeedProfit;
               graph.minPriceProfit += graph.graphAdjustSpeedProfit;
            } else {
               graph.maxPriceProfit -= graph.graphAdjustSpeedProfit;
               graph.minPriceProfit -= graph.graphAdjustSpeedProfit;
            }
        }
    };

    function millisToTime(timeStamp) {
         var secs = (timeStamp - graph.adminStartTime) / 1000000000;
         var mins = Math.trunc(secs / 60);
         secs %= 60;
         return mins + ":" + ("00" + secs).substr(-2, 2);
      };

    function drawTimeGridLines() {
         //Draw rectangles for time grid lines
         graph.profitSVG.selectAll("rect.time-grid-box-dark")
            .data(graph.timeLines)
            .enter()
            .append("rect")
            .filter(function (d) {
               // only draw elements that are an even number of increments from the start
               return ((d - graph.adminStartTime) / (graph.timeIncrement * 1000000000)) % 2 == 0;      //was 1000 7/27/17
            })
            .attr("x", function (d) {
               return mapTimeToXAxis(d);
            })
            .attr("y", 0)
            .attr("width", graph.timeIncrement / graph.timeInterval * (graph.profitElementWidth - graph.axisLabelWidth - graph.graphPaddingRight))   //changed 7/27/17 (width)
            .attr("height", graph.profitElementHeight)
            .attr("class", "time-grid-box-dark");

         //Draw labels for time grid lines
         graph.profitSVG.selectAll("text.time-grid-line-text")
            .data(graph.timeLines)
            .enter()
            .append("text")
            .attr("text-anchor", "start")
            .attr("x", function (d) {
               return mapTimeToXAxis(d) + 5;
            })
            .attr("y", graph.profitElementHeight - 5)
            .text(function (d) {
               return millisToTime(d)
            })
            .attr("class", "time-grid-line-text");
    };


    function init(startFP, startingWealth) {
         // set price bounds for both graphs
        graph.maxPriceProfit = startingWealth + graph.maxSpread;
        graph.minPriceProfit = startingWealth - graph.maxSpread;
        graph.centerPriceProfit = (graph.maxPriceProfit + graph.minPriceProfit) / 2;
        graph.profit = startingWealth;

        graph.timePerPixel = graph.timeInterval * 1000 / (graph.profitElementWidth - graph.axisLabelWidth - graph.graphPaddingRight);   
        graph.advanceTimeShown = graph.timePerPixel * (graph.axisLabelWidth + graph.graphPaddingRight);

        graph.zoomAmount = graph.maxSpread / 2;
        graph.widthScale = 10 / graph.maxSpread;
        graph.profitPriceLines = calcPriceGridLines(graph.maxPriceProfit, graph.minPriceProfit, graph.profitPriceGridIncrement);
        graph.timeLines = calcTimeGridLines(graph.adminStartTime, graph.adminStartTime + graph.timeInterval * 1000000000 + graph.advanceTimeShown, graph.timeIncrement * 1000000000);
    };

    function draw() {
        //Clear the svg elements
        graph.profitSVG.selectAll("*").remove();


        graph.currentTime =  getTime() - graph.timeOffset
        graph.timeSinceStart = (graph.currentTime - graph.adminStartTime) / 1000000000;
        /*
        if (graph.expandedGraph) {
            graph.timeInterval = graph.timeSinceStart;
            graph.timePerPixel = graph.timeInterval * 1000000000 / (graph.elementWidth - graph.axisLabelWidth - graph.graphPaddingRight);
            graph.advanceTimeShown = graph.timePerPixel * (graph.axisLabelWidth + graph.graphPaddingRight);

            graph.maxPriceMarket = Math.max(dataHistory.highestMarketPrice + 1, graph.prevMaxPriceMarket);
            graph.minPriceMarket = Math.min(dataHistory.lowestMarketPrice - 1, graph.prevMinPriceMarket);
            graph.maxPriceProfit = Math.max(dataHistory.highestProfitPrice + 1, graph.prevMaxPriceProfit);
            graph.minPriceProfit = Math.min(dataHistory.lowestProfitPrice - 1, graph.prevMinPriceProfit);
        }
        */
        graph.curTimeX = mapTimeToXAxis(graph.currentTime);

        // recalculate market price bounds
        calcPriceBounds();

        //Check if it is necessary to recalculate timeLines
        // recalculate if right edge of graph is more than a batch length past last batch line
        // or if left edge is more than a batch length past first batch line
        // Math.max expression finds time at left edge of screen
        if (graph.currentTime + graph.advanceTimeShown > graph.timeLines[graph.timeLines.length - 1] + graph.timeIncrement ||
            Math.max(graph.adminStartTime, graph.currentTime - graph.timeInterval * 1000000000) < graph.timeLines[0] - graph.timeIncrement) {
            graph.timeLines = calcTimeGridLines(graph.currentTime - graph.timeInterval * 1000000000, graph.currentTime + graph.advanceTimeShown, graph.timeIncrement * 1000000000);
        }

        //Invoke all of the draw functions
        //graph.drawTimeGridLines(graphRefr, graph.marketSVG);
        drawTimeGridLines();

        /*
        //graph.drawPriceGridLines(graphRefr, graph.marketPriceLines, graph.marketSVG, graph.mapMarketPriceToYAxis);
        graph.drawPriceGridLines(graphRefr, graph.profitPriceLines, graph.profitSVG, graph.mapProfitPriceToYAxis);

        graph.drawLaserOffers(graphRefr, dataHistory);
        graph.drawLaserTransactions(graphRefr, dataHistory.transactions, dataHistory.myId);
        graph.DrawSnipe(graphRefr, dataHistory);
         
        if(graph.oldFundPrice == null){
            graph.oldFundPrice = dataHistory.curFundPrice[1];   //initialize
            graph.FPCswing = 0;
        }else if(graph.oldFundPrice != dataHistory.curFundPrice[1]){               //the value jumped, draw the yellow line
            graph.FPCswing = ((dataHistory.curFundPrice[1] - graph.oldFundPrice) * graphRefr.elementHeight / graphRefr.priceRange).toFixed(2);
            if(graph.FPCop > 0){                                                 //while still visible
                graph.drawFundamentalValue(graphRefr, dataHistory);
            }else{
                graph.oldFundPrice = dataHistory.curFundPrice[1];                 //update our checker
                graph.FPCop = 1;            
            }                                     //reset opacity
        }  



        //graph.drawMarket(graphRefr, dataHistory.pastFundPrices, dataHistory.curFundPrice, "price-line");
        //graph.drawPriceAxis(graphRefr, graph.marketPriceLines, graph.marketSVG, graph.mapMarketPriceToYAxis);
        graph.drawPriceAxis(graphRefr, graph.profitPriceLines, graph.profitSVG, graph.mapProfitPriceToYAxis);
        graph.drawAllProfit(graphRefr, dataHistory);
        requestAnimationFrame(draw)
        */
      };


    init(10000, 20000);

    requestAnimationFrame(draw)

}
</script>
{% endblock %}
 